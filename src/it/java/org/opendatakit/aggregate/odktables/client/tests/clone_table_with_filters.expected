# Set up
createUser user1
createUser user2

createSynchronizedTable user1 people

insertSynchronizedRows user1 people 

setTablePermissions user1 user2 people true false false

# Test basic filter
cloneSynchronizedTableWithFilters user2 people
    
printTable user2 people
table properties: null
column properties:
    age null
    name null
    weight null
modification: 1
    row2
        age 50
        name John
        weight 200.0000000000
    row3
        age 40
        name Jessica
        weight 140.0000000000
    
removeTableSynchronization user2 people

# Test removing synchronization removed filters
cloneSynchronizedTable user2 people

printTable user2 people
table properties: null
column properties:
    age null
    name null
    weight null
modification: 1
    row1
        age 22
        name Dylan
        weight 175.0000000000
    row2
        age 50
        name John
        weight 200.0000000000
    row3
        age 40
        name Jessica
        weight 140.0000000000

removeTableSynchronization user2 people

# Test somewhat complex filter
cloneSynchronizedTableWithFilters user2 people

printTable user2 people
table properties: null
column properties:
    age null
    name null
    weight null
modification: 1
    row3
        age 40
        name Jessica
        weight 140.0000000000

# Test synchronize
insertSynchronizedRows user1 people
        
synchronize user2 people

printTable user2 people
table properties: null
column properties:
    age null
    name null
    weight null
modification: 2
    row3
        age 40
        name Jessica
        weight 140.0000000000
    row4
        age 40
        name JessicasTwin
        weight 140.0000000000

# Test that we can synchronize twice in a row
synchronize user2 people

removeTableSynchronization user2 people

# Test that user can't filter by non-existent column
cloneSynchronizedTableWithFilters user2 people
Exception: org.opendatakit.aggregate.odktables.client.exception.ColumnDoesNotExistException: Column with name nosuchcolumn does not exist in table with tableID people

# Test that user can't filter by values of the wrong type
cloneSynchronizedTableWithFilters user2 people
Exception: org.opendatakit.aggregate.odktables.client.exception.FilterValueTypeMismatchException: Value notanumber can not be interpreted as type INTEGER

# Clean up
setTablePermissions user1 user2 people false false false
deleteSynchronizedTable user1 people
deleteUser user1
deleteUser user2